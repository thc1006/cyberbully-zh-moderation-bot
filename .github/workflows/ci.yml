name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 9 é»žåŸ·è¡Œï¼ˆUTC æ™‚é–“ 1 é»žï¼‰
    - cron: '0 1 * * 1'

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '18'
  POETRY_VERSION: '1.7.0'

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œæ•´ git æ­·å²ï¼Œç”¨æ–¼æŸäº›åˆ†æžå·¥å…·

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -U -r requirements.txt -r requirements-dev.txt --prefer-binary

    - name: ðŸŽ¨ Format check with Black
      run: |
        black --check --diff src/ tests/ api/ bot/
      continue-on-error: true

    - name: ðŸ” Lint with Flake8
      run: |
        flake8 src/ tests/ api/ bot/ --config=.flake8
      continue-on-error: true

    - name: ðŸ“ Sort imports with isort
      run: |
        isort --check-only --diff src/ tests/ api/ bot/
      continue-on-error: true

    - name: ðŸ”’ Docstring check with pydocstyle
      run: |
        pydocstyle src/ --config=.pydocstyle
      continue-on-error: true

    - name: ðŸ“Š Code complexity with radon
      run: |
        radon cc src/ -s -nb
        radon mi src/ -s
      continue-on-error: true

  # åž‹åˆ¥æª¢æŸ¥
  type-checking:
    name: Type Checking
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -U -r requirements.txt -r requirements-dev.txt --prefer-binary
        pip install mypy types-requests types-PyYAML

    - name: ðŸ” Type check with mypy
      run: |
        mypy src/ api/ bot/ --config-file=mypy.ini
      continue-on-error: true

  # å®‰å…¨æŽƒæ
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] safety semgrep

    - name: ðŸ”’ Security scan with Bandit
      run: |
        bandit -r src/ api/ bot/ -f json -o bandit-report.json
        bandit -r src/ api/ bot/ -f screen -ll
      continue-on-error: true

    - name: ðŸ“¦ Dependency check with Safety
      run: |
        safety check --json > safety-report.json || true
        safety check || true
      continue-on-error: true

    - name: ðŸ” SAST with Semgrep
      run: |
        semgrep --config=auto src/ api/ bot/ --json -o semgrep-report.json || true
        semgrep --config=auto src/ api/ bot/ || true
      continue-on-error: true

    - name: ðŸ“¤ Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          semgrep-report.json

  # å–®å…ƒæ¸¬è©¦
  unit-tests:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12']
      fail-fast: false

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -U -r requirements.txt -r requirements-dev.txt --prefer-binary

    - name: ðŸ§ª Run unit tests
      run: |
        pytest tests/ \
          --cov=src/cyberpuppy \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junitxml=junit.xml \
          -v

    - name: ðŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          junit.xml
          htmlcov/
          coverage.xml

  # æ•´åˆæ¸¬è©¦
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -U -r requirements.txt -r requirements-dev.txt --prefer-binary

    - name: ðŸ”§ Set up environment
      run: |
        cp .env.example .env
        echo "REDIS_URL=redis://localhost:6379" >> .env

    - name: ðŸ§ª Run integration tests
      run: |
        pytest tests/integration/ -v --tb=short
      continue-on-error: true

  # Docker å»ºæ§‹æ¸¬è©¦
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v6

    - name: ðŸ“‹ List context files
      run: |
        echo "API context files:"
        ls -la ./api/
        echo "Bot context files:"
        ls -la ./bot/
        echo "Root requirements files:"
        ls -la requirements*.txt

    - name: ðŸ—ï¸ Build API Docker image
      uses: docker/build-push-action@v6
      with:
        context: ./api
        push: false
        tags: cyberpuppy-api:test
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: ðŸ—ï¸ Build Bot Docker image
      uses: docker/build-push-action@v6
      with:
        context: ./bot
        push: false
        tags: cyberpuppy-bot:test
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: ðŸ” List built Docker images
      run: docker images | grep -E "(cyberpuppy|REPOSITORY)"

    - name: ðŸ§ª Test Docker containers
      run: |
        echo "Testing API container..."
        docker run --rm cyberpuppy-api:test python -c "import fastapi; print('API container OK')"
        echo "Testing Bot container..."
        docker run --rm cyberpuppy-bot:test python -c "import linebot; print('Bot container OK')"

  # æ–‡æª”å»ºæ§‹æ¸¬è©¦
  documentation:
    name: Documentation Build
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install documentation dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints myst-parser

    - name: ðŸ“š Build documentation
      run: |
        cd docs
        make html
      continue-on-error: true

    - name: ðŸ“¤ Upload documentation
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: documentation
        path: docs/_build/html/

  # ä¾è³´æª¢æŸ¥
  dependency-check:
    name: Dependency License Check
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install pip-licenses
      run: |
        python -m pip install --upgrade pip
        pip install pip-licenses

    - name: ðŸ“‹ Check licenses
      run: |
        pip-licenses --format=markdown --with-urls --output-file=LICENSES.md
        pip-licenses --fail-on="GPL;LGPL"
      continue-on-error: true

    - name: ðŸ“¤ Upload license report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-report
        path: LICENSES.md

  # æ•ˆèƒ½æ¸¬è©¦ï¼ˆåƒ…åœ¨ä¸»åˆ†æ”¯ï¼‰
  performance-test:
    name: Performance Testing
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [unit-tests]

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -U -r requirements.txt -r requirements-dev.txt --prefer-binary
        pip install locust pytest-benchmark

    - name: ðŸƒ Run performance benchmarks
      run: |
        pytest tests/performance/ --benchmark-only --benchmark-json=benchmark.json
      continue-on-error: true

    - name: ðŸ“¤ Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results
        path: benchmark.json

  # ç¸½çµå ±å‘Š
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, type-checking, security-scan, unit-tests, docker-build]
    if: always()

    steps:
    - name: ðŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4

    - name: ðŸ“Š Generate summary report
      run: |
        echo "# CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Pipeline Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Type Checking | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Build | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Notes" >> $GITHUB_STEP_SUMMARY
        echo "- All checks completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- Artifacts available for download" >> $GITHUB_STEP_SUMMARY