name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# é¿å…åŒåˆ†æ”¯é‡è¤‡è·‘ï¼ˆæ–° run æœƒå–æ¶ˆèˆŠ runï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PIP_NO_CACHE_DIR: 1
  PYTHONUNBUFFERED: 1

jobs:
  # 0) åŸºç¤Žæ¸¬è©¦ - å¿«é€Ÿå¤±æ•—ï¼Œç”¨ä¾†æ—©æœŸå›žé¥‹
  basic-tests:
    name: Basic Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install core dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt -r requirements-dev.txt
      - name: Run basic unit tests
        run: |
          # è‹¥å°šæœªå°Žå…¥ markersï¼Œå…ˆç”¨æª”åç¯„åœè·‘åŸºç¤Žæ¸¬è©¦
          pytest tests/test_*.py -v --tb=short --maxfail=5 -x

  # 1) å®Œæ•´å–®å…ƒæ¸¬è©¦ï¼ˆå¯æ“´ OS / Python matrixï¼‰
  unit-tests:
    name: Unit (${{ matrix.os }} / Py ${{ matrix.python-version }})
    needs: basic-tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt -r requirements-dev.txt
      - name: Run unit tests with coverage
        run: |
          # è‹¥å·²å°Žå…¥ markersï¼šæ”¹ç‚º -m "unit and not integration and not docker"
          pytest tests/ --ignore=tests/integration/ --cov=src/cyberpuppy --cov-report=xml --cov-report=term-missing --tb=short -v
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        if: ${{ matrix.python-version == '3.11' }}
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          # ç§æœ‰æˆ–å—ä¿è­·æƒ…å¢ƒå»ºè­°åŠ ä¸Š token
          token: ${{ secrets.CODECOV_TOKEN }}

  # 2) æ•´åˆæ¸¬è©¦ï¼ˆLinuxï¼›Service Containersï¼‰
  integration-tests:
    name: Integration (Redis service)
    needs: unit-tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    services:
      redis:
        image: redis:7-alpine
        ports: [ "6379:6379" ] # éžå¿…éœ€ï¼Œä½†ä¿ç•™äº¦å¯
        options: >-
          --health-cmd "redis-cli -h redis ping || exit 1"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=30
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt -r requirements-dev.txt
      - name: Set up test environment
        run: |
          cp -f .env.example .env
          echo "REDIS_URL=redis://redis:6379" >> .env   # ä½¿ç”¨æœå‹™ä¸»æ©Ÿå redis
          echo "ENVIRONMENT=testing" >> .env
          echo "TESTING=1" >> .env
      - name: Run integration tests (retry once on flake)
        run: |
          set -e
          # è‹¥å·²å°Žå…¥ markersï¼špytest -m "integration and not docker" -v --tb=short
          pytest tests/integration/ -v --tb=short || (echo "retrying..." && sleep 5 && pytest tests/integration/ -v --tb=short)

  # 3) Docker å»ºæ§‹ï¼è¼•é‡åŸ·è¡Œæ¸¬è©¦ï¼ˆLinux onlyï¼‰
  docker-test:
    name: Docker Build Test
    needs: unit-tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build API image
        run: docker build --pull -t cyberpuppy-api:test -f api/Dockerfile .
      - name: Build Bot image
        run: docker build --pull -t cyberpuppy-bot:test -f bot/Dockerfile .
      - name: Smoke-run containers
        run: |
          docker run --rm cyberpuppy-api:test python -c "import fastapi; print('API OK')"
          docker run --rm cyberpuppy-bot:test python -c "import linebot; print('Bot OK')"

  # 4) Code Qualityï¼ˆä½ åŽŸæœ¬å…è¨±å¿½ç•¥éŒ¯èª¤ï¼Œé€™è£¡ä¿ç•™ but å¯è§€æ¸¬ï¼‰
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - run: |
          python -m pip install --upgrade pip
          pip install black flake8 isort mypy
      - name: Black
        run: black --check --diff src/ tests/ api/ bot/
      - name: isort
        run: isort --check-only --diff src/ tests/ api/ bot/
      - name: flake8
        run: flake8 src/ tests/ api/ bot/ --config=.flake8

  # 5) Securityï¼ˆå·¥å…·å¸¸è®Šå‹•ï¼Œä¿ç•™éžé˜»æ–·ï¼‰
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] safety
      - name: Bandit
        run: bandit -r src/ api/ bot/ -ll
      - name: Safety
        run: safety check || true

  # 6) Windowsï¼šåªé©—è­‰æœ€åŸºæœ¬å–®å…ƒæ¸¬è©¦ï¼ˆä¸è·‘ Docker/æ•´åˆï¼‰
  windows-test:
    name: Windows Basic
    if: github.event_name == 'pull_request'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt -r requirements-dev.txt
      - name: Run basic tests
        run: pytest tests/test_*.py -v --maxfail=10

  # 7) CI Summaryï¼ˆå½™ç¸½çµæžœï¼‰
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs:
      - basic-tests
      - unit-tests
      - integration-tests
      - docker-test
      - code-quality
      - security
      - windows-test
    steps:
      - name: Generate summary
        run: |
          echo "# CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Basic Tests | ${{ needs.basic-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.windows-test.result }} |" >> $GITHUB_STEP_SUMMARY